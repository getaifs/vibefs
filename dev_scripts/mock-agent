#!/bin/bash
# Mock agent for testing VibeFS agent launch flow
# Simulates an AI agent that makes code changes
#
# Usage: vibe mock-agent [options]
#
# This gets launched via `vibe mock-agent` or `vibe new --agent mock-agent`
# It simulates an agent by:
# 1. Showing received arguments
# 2. Making some file changes
# 3. Optionally running interactively

set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}========================================${NC}"
echo -e "${CYAN}  Mock Agent v1.0${NC}"
echo -e "${CYAN}========================================${NC}"
echo ""

# Show where we are
echo -e "${BLUE}Working directory:${NC} $(pwd)"
echo ""

# Show received arguments
if [ $# -gt 0 ]; then
    echo -e "${BLUE}Received arguments:${NC}"
    for arg in "$@"; do
        echo "  - $arg"
    done
    echo ""
fi

# Parse flags
INTERACTIVE=false
MAKE_CHANGES=true
DELAY=0

while [[ $# -gt 0 ]]; do
    case $1 in
        --interactive|-i)
            INTERACTIVE=true
            shift
            ;;
        --no-changes)
            MAKE_CHANGES=false
            shift
            ;;
        --delay)
            DELAY="$2"
            shift 2
            ;;
        *)
            # Unknown flag - just skip (simulates agent accepting arbitrary flags)
            shift
            ;;
    esac
done

# Simulate agent "thinking"
echo -e "${BLUE}Analyzing codebase...${NC}"
sleep 0.5

# List existing files
echo ""
echo -e "${BLUE}Found files:${NC}"
find . -type f -name "*.rs" -o -name "*.md" -o -name "*.txt" 2>/dev/null | head -10 | while read -r f; do
    echo "  $f"
done
echo ""

# Make some changes
if $MAKE_CHANGES; then
    echo -e "${BLUE}Making changes...${NC}"

    # Create a new file
    NEW_FILE="agent_generated.rs"
    cat > "$NEW_FILE" << 'EOF'
//! Auto-generated by mock-agent
//! This file was created to test VibeFS agent workflows

/// A function created by the mock agent
pub fn agent_feature() -> String {
    "Hello from mock-agent!".to_string()
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_agent_feature() {
        assert_eq!(agent_feature(), "Hello from mock-agent!");
    }
}
EOF
    echo -e "${GREEN}  Created:${NC} $NEW_FILE"

    # Modify README if it exists
    if [ -f "README.md" ]; then
        echo "" >> README.md
        echo "## Agent Notes" >> README.md
        echo "" >> README.md
        echo "Modified by mock-agent at $(date)" >> README.md
        echo -e "${GREEN}  Modified:${NC} README.md"
    fi

    # Create a simple change log
    echo "$(date): mock-agent ran with args: $*" >> .agent-log.txt
    echo -e "${GREEN}  Created:${NC} .agent-log.txt"

    echo ""
fi

# Simulate processing delay if specified
if [ "$DELAY" -gt 0 ]; then
    echo -e "${BLUE}Processing for ${DELAY}s...${NC}"
    sleep "$DELAY"
fi

# Summary
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  Mock Agent Complete${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo "Session changes:"
echo "  - Created agent_generated.rs"
echo "  - Modified README.md"
echo "  - Created .agent-log.txt"
echo ""
echo -e "${YELLOW}Next steps:${NC}"
echo "  vibe status         # See session status"
echo "  vibe diff           # See your changes"
echo "  vibe promote        # Commit changes to git"
echo "  vibe close          # Close session"
echo ""

# Interactive mode
if $INTERACTIVE; then
    echo -e "${BLUE}Entering interactive mode...${NC}"
    echo "Type 'exit' to quit"
    echo ""
    exec "$SHELL"
fi

exit 0
